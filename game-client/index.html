<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WS Test</title>
  <style>
    :root { --bg: #1a1a1a; --fg: #e0e0e0; --acc: #00d4ff; --err: #ff4d4d; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--fg); font:14px/1.5 system-ui; padding:16px; display:flex; flex-direction:column; gap:12px; min-height:100vh; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    button { background:var(--acc); color:#000; border:none; padding:10px 14px; border-radius:6px; font-weight:600; cursor:pointer; flex:1; min-width:100px; }
    button:disabled { opacity:0.4; cursor:not-allowed; }
    button.err { background:var(--err); }
    input, textarea { flex:1; padding:10px; border:1px solid #444; border-radius:6px; background:#222; color:var(--fg); }
    #log { flex:1; background:#111; padding:12px; border-radius:6px; overflow:auto; font-family:monospace; font-size:13px; max-height:50vh; }
    .msg { margin:4px 0; }
    .open { color:#4ade80; }
    .close { color:#fb923c; }
    .error { color:var(--err); }
    .sent { color:#a5b4fc; }
  </style>
</head>
<body>
  <div class="row">
    <input id="host" placeholder="Host" value="echo.websocket.org" />
    <button id="init">Khởi tạo</button>
  </div>
  <div class="row">
    <button id="connect">Connect</button>
    <button id="disconnect">Disconnect</button>
    <button id="reconnect">Reconnect</button>
    <button id="autoconnect">Autoconnect</button>
  </div>
  <div class="row">
    <button id="sendStr">Gửi String</button>
    <button id="sendNum">Gửi Number</button>
    <button id="sendObj">Gửi Object</button>
    <button id="sendArr">Gửi Array</button>
  </div>
  <div class="row">
    <button id="sendU8">Gửi Uint8Array</button>
    <button id="sendU16">Gửi Uint16Array</button>
    <button id="sendU32">Gửi Uint32Array</button>
    <button id="sendBuf">Gửi ArrayBuffer</button>
  </div>
  <div class="row">
    <button id="send100">Gửi 100</button>
    <button id="send1000">Gửi 1000</button>
  </div>
  <div id="log"></div>

  <script type="module">
    import { WS } from './WS.js';

    const $ = id => document.getElementById(id);
    const log = (msg, cls = '') => {
      const div = document.createElement('div');
      div.className = `msg ${cls}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      $('log').appendChild(div);
      div.scrollIntoView();
    };

    let ws = null;
    const getUrl = () => `wss://${$('host').value.trim() || 'echo.websocket.org'}`;

    const init = () => {
      try {
        ws = new WS(getUrl());
        ws.on('open', () => log('Kết nối thành công', 'open'));
        ws.on('close', () => log('Ngắt kết nối', 'close'));
        ws.on('error', e => log(`Lỗi: ${e.message || e}`, 'error'));
        ws.on('message', d => log(`← ${typeof d === 'object' ? JSON.stringify(d) : d}`, 'sent'));
        ws.on('reconnectfailed', () => log('Tự động kết nối thất bại', 'error'));
        log('Khởi tạo WS thành công');
        $('init').disabled = true;
      } catch (e) {
        log(`Khởi tạo thất bại: ${e.message}`, 'error');
      }
    };

    $('init').onclick = init;
    $('connect').onclick = () => { try { ws.connect(); } catch (e) { log(e.message, 'error'); } };
    $('disconnect').onclick = () => { try { ws.disconnect(); } catch (e) { log(e.message, 'error'); } };
    $('reconnect').onclick = () => { try { ws.reconnect(); } catch (e) { log(e.message, 'error'); } };
    $('autoconnect').onclick = () => { try { ws.autoconnect(); } catch (e) { log(e.message, 'error'); } };

    const send = (data, type = '') => {
      try {
        if (type === 'bytes') {
          ws.sendBytes(data);
          log(`→ [${type}] ${data instanceof ArrayBuffer ? 'ArrayBuffer' : data.constructor.name} [${[...new Uint8Array(data.buffer || data)].join(', ')}]`, 'sent');
        } else {
          ws.send(data);
          log(`→ [${type}] ${typeof data === 'object' ? JSON.stringify(data) : data}`, 'sent');
        }
      } catch (e) { log(e.message, 'error'); }
    };

    $('sendStr').onclick = () => send('Hello WebSocket! Đã test tiếng Việt OK', 'string');
    $('sendNum').onclick = () => send(123456789, 'number');
    $('sendObj').onclick = () => send({ action: 'test', value: Math.random(), time: Date.now(), ok: true }, 'object');
    $('sendArr').onclick = () => send([1, "text", null, { x: 10 }, true, [9, 8]], 'array');

    $('sendU8').onclick = () => {
      const arr = new Uint8Array(8);
      crypto.getRandomValues(arr);
      send(arr, 'bytes');
    };
    $('sendU16').onclick = () => {
      const arr = new Uint16Array(4);
      crypto.getRandomValues(arr);
      send(arr, 'bytes');
    };
    $('sendU32').onclick = () => {
      const arr = new Uint32Array(2);
      crypto.getRandomValues(arr);
      send(arr, 'bytes');
    };
    $('sendBuf').onclick = () => {
      const buf = new ArrayBuffer(16);
      const view = new Uint8Array(buf);
      crypto.getRandomValues(view);
      send(buf, 'bytes');
    };

    const sendMany = n => {
      for (let i = 0; i < n; i++) send({ i, t: Date.now(), r: Math.random() }, 'bulk');
    };
    $('send100').onclick = () => sendMany(100);
    $('send1000').onclick = () => sendMany(1000);
  </script>
</body>
</html>
