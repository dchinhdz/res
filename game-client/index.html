<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>WS Test</title>
  <style>
    body { background: #111; color: #eee; font-family: monospace; padding: 20px; }
    .log { white-space: pre-wrap; }
    .ok { color: #6f6; }
    .err { color: #f66; }
    .evt { color: #6cf; }
    button { margin: 5px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; background: #333; color: #fff; }
    button:hover { background: #555; }
  </style>
</head>
<body>
  <h2>ðŸ”— WebSocket Test (WS.js)</h2>
  <div>
    <button id="connect">Connect</button>
    <button id="sendAll">Send All Types</button>
    <button id="disconnect">Disconnect</button>
  </div>
  <div id="log" class="log"></div>

  <script type="module">
    import { WS } from './WS.js';

    const logBox = document.getElementById('log');
    const log = (msg, cls='') => {
      const el = document.createElement('div');
      if (cls) el.className = cls;
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logBox.appendChild(el);
      logBox.scrollTop = logBox.scrollHeight;
    };

    const ws = WS.get('https://demo.piesocket.com/v3/channel_123?api_key=VCXCEuvhGcBDP7XhiJJUDvR1e1D3eiVjgZ9VRiaV&notify_self');

    ws.on('open', () => log('Connected âœ…', 'ok'));
    ws.on('close', () => log('Disconnected âŒ', 'evt'));
    ws.on('error', e => log('Socket Error: ' + e.message, 'err'));
    ws.on('senderror', (err, ctx) => log('Send Error: ' + err.message + ' | data=' + JSON.stringify(ctx.data), 'err'));
    ws.on('message', data => {
      try {
        const auto = ws.read(data);
        log('ðŸ“¥ Received auto-read: ' + JSON.stringify(auto), 'evt');
        //try { log('Uint auto: ' + ws.readUint(data), 'evt'); } catch {}
        //try { log('Int auto: ' + ws.readInt(data), 'evt'); } catch {}
        //try { log('Float auto: ' + ws.readFloat(data), 'evt'); } catch {}
      } catch (err) {
        log('Read Error: ' + err.message, 'err');
      }
    });

    document.getElementById('connect').onclick = () => {
      try { ws.connect(); log('Connecting...', 'evt'); }
      catch (err) { log('Connect Error: ' + err.message, 'err'); }
    };

    document.getElementById('disconnect').onclick = () => {
      try { ws.disconnect(); log('Manually disconnected', 'evt'); }
      catch (err) { log('Disconnect Error: ' + err.message, 'err'); }
    };

    document.getElementById('sendAll').onclick = () => {
      try {
        ws.send("Hello world");
        ws.send(2025);
        ws.send({ user: "dev", time: Date.now() });
        ws.send([1, 2, 3, "mix"]);

        ws.sendUint([1, 2, 255]);
        ws.sendUint([1000, 50000]);
        //ws.sendUint([10n, 20n, 9999999999999n]);

        ws.sendInt([-10, 20, -128]);
        ws.sendInt([-30000, 20000]);
        //ws.sendInt([-9999999999n, 9999999999n]);

        ws.sendFloat([1.23, 4.56, 7.89]);
        ws.sendFloat([1.2345678901234567]);

        log('All send tests executed!', 'ok');
      } catch (err) {
        log('Send Error: ' + err.message, 'err');
      }
    };
  </script>
</body>
</html>
