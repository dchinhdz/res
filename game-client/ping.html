<!DOCTYPE html>
<html>
<head>
  <title>Ping WebSocket</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    #log { white-space: pre; }
  </style>
</head>
<body>
  <h3>WebSocket Ping to echo.websocket.org</h3>
  <div id="log"></div>

  <script>
    const log = document.getElementById('log');
    const url = 'wss://echo.websocket.org';
    let ws, pingTimer, reconnectTimer, pingStart;

    function appendLog(msg) {
      log.textContent += `[${new Date().toLocaleTimeString()}]: ${msg}\n`;
    }

    function sendPing() {
      if (ws?.readyState !== WebSocket.OPEN) return;
      pingStart = performance.now();
      ws.send(new Uint8Array([255])); // Gửi ping (byte 255)
    }

    function connect() {
      clearTimeout(reconnectTimer);
      ws = new WebSocket(url);

      ws.onopen = () => {
        appendLog('Đã kết nối');
        sendPing();
        pingTimer = setInterval(sendPing, 5000);
      };

      ws.onmessage = (e) => {
        if (e.data instanceof Blob) {
          const reader = new FileReader();
          reader.onload = () => {
            if (reader.result === 255 && pingStart) {
              const ms = Math.round(performance.now() - pingStart);
              appendLog(`${ms} ms`);
            }
          };
          reader.readAsArrayBuffer(e.data);
        }
      };

      ws.onerror = () => appendLog('Lỗi kết nối');
      ws.onclose = () => {
        appendLog('Mất kết nối, đang thử lại...');
        clearInterval(pingTimer);
        reconnectTimer = setTimeout(connect, 3000); // Reconnect sau 3s
      };
    }

    connect(); // Khởi động lần đầu
  </script>
</body>
</html>
