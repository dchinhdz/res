<!DOCTYPE html>
<html>
<head>
  <title>Ping WebSocket</title>
  <style>
    body{font-family:monospace;padding:20px}
    #log{white-space:pre;height:300px;overflow:auto;border:1px solid #ccc;padding:10px}
  </style>
</head>
<body>
  <h3>WebSocket Ping (5s) + Auto Reconnect</h3>
  <div id="log"></div>

  <script>
    const log=document.getElementById('log'),url='wss://echo.websocket.org';
    let ws,pingTimer,reconnectTimer,pingStart;
    const t=()=>new Date().toLocaleTimeString();
    const a=m=>log.textContent+=`[${t()}]: ${m}\n`;

    const ping=()=>{if(ws?.readyState===1){pingStart=performance.now();ws.send(new Uint8Array([255]));}};
    const connect=()=>{
      clearTimeout(reconnectTimer);
      ws=new WebSocket(url);
      ws.binaryType='arraybuffer';
      ws.onopen=()=>{a('Kết nối');clearInterval(pingTimer);pingTimer=setInterval(ping,5000);ping();}
      ws.onmessage=e=>{const d=e.data;if(d instanceof ArrayBuffer&&d.byteLength===1&&new Uint8Array(d)[0]===255&&pingStart){a(`Ping: ${Math.round(performance.now()-pingStart)} ms`);pingStart=null;}}
      ws.onerror=()=>a('Lỗi');
      ws.onclose=()=>{a('Ngắt → Thử lại 3s');clearInterval(pingTimer);reconnectTimer=setTimeout(connect,3000);}
    };
    connect();
  </script>
</body>
</html>
