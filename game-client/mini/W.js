export class W{static p=new Map,d={m:5,t:3e3};u;o;w;c=0;a=0;r=0;e=new Map;constructor(u,o={}){this.u=u||`${location.protocol==="https:"?"wss":"ws"}://${location.host}/`,this.o={...W.d,...o},W.p.has(this.u)?this=W.p.get(this.u):W.p.set(this.u,this)}f=(v,...a)=>this.e.get(v)?.forEach(h=>h(...a));n=(v,h)=>((this.e.has(v)?this.e.get(v):this.e.set(v,new Set).get(v)).add(h));z=()=>{this.w=this.c=this.a=null,this.r=0};C(){if(this.c||this.w?.readyState===1)return this.f("e",new Error("Already connected"));this.a=0;try{const s=this.w=new WebSocket(this.u);s.binaryType="arraybuffer",s.onopen=()=>{this.c=1,this.r=0,this.f("o")},s.onerror=e=>this.f("e",e),s.onclose=()=>{const x=this.c;this.w=null,this.c=0,this.f("l"),this.a&&x&&this.R()},s.onmessage=e=>this.h(e)}catch(e){this.f("e",e);throw e}}D(){if(!this.c&&(!this.w||this.w.readyState===3))return this.f("e",new Error("Not connected"));this.a=0,this.w?.close(1e3),this.z(),W.p.delete(this.u)}R(){this.z(),W.p.delete(this.u),this.C()}A(t=this.o.t,m=this.o.m){if(this.c||this.w?.readyState===1)return this.f("e",new Error("Already connected"));this.a=1,this.o.t=t,this.o.m=m,this.X()}X=()=>{if(this.r++>=this.o.m)return this.a=0,this.f("f");setTimeout(()=>this.C(),this.o.t*this.r)}h=e=>{let d=e.data;if(typeof d=="string")try{d=JSON.parse(d)}catch{}else if(d instanceof Blob)return void d.arrayBuffer().then(b=>this.f("m",b));this.f("m",d)}S=d=>{if(!this.c||!this.w)throw new Error("WebSocket not open");this.w.send(typeof d=="object"?JSON.stringify(d):String(d))}B=d=>{if(!this.c||!this.w)throw new Error("WebSocket not open");if(!(d instanceof ArrayBuffer)&&!ArrayBuffer.isView(d))throw new TypeError("sendBytes: ArrayBuffer or TypedArray required");const b=d instanceof ArrayBuffer?d:d.buffer,o=d.byteOffset||0,l=d.byteLength||b.byteLength;this.w.send(b.slice(o,o+l))}}
