<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Socket Test</title><style>
  body{font:14px monospace;background:#111;color:#0f0;margin:0;padding:10px;overflow:auto}
  button{margin:3px;padding:6px 10px;background:#222;border:1px solid #0f0;color:#0f0;cursor:pointer}
  button:hover{background:#0f0;color:#111}
  #log{max-height:100vh;overflow-y:auto;white-space:pre-wrap;word-break:break-all}
</style></head><body>

<h3>Send Types</h3>
<button onclick="sendStr()">String</button>
<button onclick="sendNum()">Number</button>
<button onclick="sendObj()">Object</button>
<button onclick="sendArr()">Array</button>
<button onclick="sendBin()">Binary Pack</button>

<h3>Binary Singles</h3>
<button onclick="sendU8()">U8</button><button onclick="sendI8()">I8</button>
<button onclick="sendU16()">U16</button><button onclick="sendI16()">I16</button>
<button onclick="sendU32()">U32</button><button onclick="sendI32()">I32</button>
<button onclick="sendF32()">F32</button><button onclick="sendF64()">F64</button>

<pre id="log"></pre>

<script type="module">
import { Socket } from './Socket.js';

const $log = document.getElementById('log');
const uiLog = (type, msg = '', col = '#0f0') => {
  const t = new Date().toISOString().slice(11, -1);
  $log.insertAdjacentHTML('beforeend', `<div style="color:${col}">[${t}] ${type} ${msg}</div>`);
  $log.scrollTop = $log.scrollHeight;
};

let s;
try { s = new Socket(); }               // mặc định location.host
// let s = new Socket('wss://mygame.com/ws');
catch (e) { uiLog('FATAL', e.message, '#f00'); throw e; }

s.on(onMsg);

// ---------- Gửi ----------
const send = (type, data) => {
  try { s.send(data); uiLog(`→ ${type}`, typeof data === 'object' ? JSON.stringify(data) : data, '#ff0'); }
  catch (e) { uiLog('SEND ERR', e.message, '#f00'); }
};
const sendStr = () => send('String', 'Hello Realtime Game!');
const sendNum = () => send('Number', Math.PI);
const sendObj = () => send('Object', {x:10,y:20,dir:'up',hp:95});
const sendArr = () => send('Array', [1,2,3,'go',[true,false]]);

const sendBin = () => {
  const buf = new ArrayBuffer(1+1+2+2+4+4+4+8);
  const v = new DataView(buf); let o = 0;
  v.setUint8(o++,255); v.setInt8(o++,-128);
  v.setUint16(o,65535,true); o+=2; v.setInt16(o,-32768,true); o+=2;
  v.setUint32(o,4294967295,true); o+=4; v.setInt32(o,-2147483648,true); o+=4;
  v.setFloat32(o,3.14159,true); o+=4;
  v.setFloat64(o,-2.71828,true); o+=8;
  s.send(buf); uiLog('→ Binary Pack', `(${buf.byteLength}B)`, '#ff0');
};

const sendU8 = ()=>{const b=new Uint8Array([42]);s.send(b);uiLog('→ Uint8',42,'#ff0');};
const sendI8 = ()=>{const b=new Int8Array([-99]);s.send(b);uiLog('→ Int8',-99,'#ff0');};
const sendU16=()=>{const b=new Uint16Array([60000]);s.send(b);uiLog('→ Uint16',60000,'#ff0');};
const sendI16=()=>{const b=new Int16Array([-30000]);s.send(b);uiLog('→ Int16',-30000,'#ff0');};
const sendU32=()=>{const b=new Uint32Array([4000000000]);s.send(b);uiLog('→ Uint32',4000000000,'#ff0');};
const sendI32=()=>{const b=new Int32Array([-2000000000]);s.send(b);uiLog('→ Int32',-2000000000,'#ff0');};
const sendF32=()=>{const b=new Float32Array([1.234567]);s.send(b);uiLog('→ Float32',1.234567,'#ff0');};
const sendF64=()=>{const b=new Float64Array([Math.E]);s.send(b);uiLog('→ Float64',Math.E,'#ff0');};

// ---------- Nhận ----------
function onMsg(data){
  if(typeof data==='string'){uiLog('← String',data,'#0ff');return;}
  if(data instanceof ArrayBuffer){
    const v=new DataView(data);
    let str=`← Binary (${data.byteLength}B): `;
    if(data.byteLength===1) str+=`U8=${new Uint8Array(data)[0]} I8=${new Int8Array(data)[0]}`;
    else if(data.byteLength===2){
      const u=v.getUint16(0,true),i=v.getInt16(0,true);
      str+=`U16=${u} I16=${i}`;
    }else if(data.byteLength===4){
      const u=v.getUint32(0,true),i=v.getInt32(0,true),f=v.getFloat32(0,true);
      str+=(u>>>0===u?`U32=${u} I32=${i}`:`F32=${f.toFixed(6)}`);
    }else if(data.byteLength===8){
      str+=`F64=${v.getFloat64(0,true).toFixed(6)}`;
    }else{
      let o=0,a=[];
      a.push(`U8=${v.getUint8(o++)}`);a.push(`I8=${v.getInt8(o++)}`);
      a.push(`U16=${v.getUint16(o,true)}`);o+=2;a.push(`I16=${v.getInt16(o,true)}`);o+=2;
      a.push(`U32=${v.getUint32(o,true)}`);o+=4;a.push(`I32=${v.getInt32(o,true)}`);o+=4;
      a.push(`F32=${v.getFloat32(o,true).toFixed(5)}`);o+=4;
      a.push(`F64=${v.getFloat64(o,true).toFixed(5)}`);
      str+=a.join(' | ');
    }
    uiLog(str,'','#0ff');return;
  }
  try{uiLog('← JSON',JSON.stringify(data),'#0ff');}
  catch{uiLog('← UNKNOWN',data,'#f00');}
}
</script>
</body></html>
