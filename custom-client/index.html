<!DOCTYPE html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>WS Test</title><style>
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;font:14px/1.4 system-ui,sans-serif;background:#111;color:#0f0;overflow:hidden}
#app{display:flex;flex-direction:column;height:100vh}
#url-bar{padding:8px;background:#222;border-bottom:1px solid #0f0;display:flex;gap:4px;align-items:center}
#url-bar input{flex:1;padding:6px 8px;background:#111;border:1px solid #0f0;color:#0f0;font:inherit;border-radius:4px}
#url-bar button{padding:6px 12px;background:#111;border:1px solid #0f0;color:#0f0;border-radius:4px;cursor:pointer;font-weight:bold}
#url-bar button:disabled{background:#333;color:#666;border-color:#333;cursor:not-allowed}
#url-bar button:active:not(:disabled){background:#0f0;color:#111}
#btns{padding:8px;overflow-x:auto;white-space:nowrap;background:#111;border-bottom:1px solid #333;display:flex;gap:4px}
#btns button{font-size:12px;padding:4px 8px;background:#222;border:1px solid #0f0;color:#0f0;border-radius:4px;min-width:max-content}
#btns button:active{background:#0f0;color:#111}
#log{flex:1;overflow-y:auto;padding:8px;font-family:monospace;font-size:13px;word-break:break-all}
</style></head><body>
<div id="app">
  <div id="url-bar">
    <input id="url" type="text" value="wss://echo.websocket.org" placeholder="wss://...">
    <button id="connect">Connect</button>
  </div>
  <div id="btns">
    <button onclick="sendStr()">Str</button>
    <button onclick="sendNum()">Num</button>
    <button onclick="sendObj()">Obj</button>
    <button onclick="sendArr()">Arr</button>
    <button onclick="sendBin()">Bin</button>
    <button onclick="sendU8()">U8</button>
    <button onclick="sendI8()">I8</button>
    <button onclick="sendU16()">U16</button>
    <button onclick="sendI16()">I16</button>
    <button onclick="sendU32()">U32</button>
    <button onclick="sendI32()">I32</button>
    <button onclick="sendF32()">F32</button>
    <button onclick="sendF64()">F64</button>
  </div>
  <pre id="log"></pre>
</div>

<script type="module">
import { Socket } from './Socket.js';

const $url = document.getElementById('url');
const $connect = document.getElementById('connect');
const $log = document.getElementById('log');
const l = (t, m = '', c = '#0f0') => {
  const n = new Date().toISOString().slice(11, -1);
  $log.insertAdjacentHTML('beforeend', `<div style="color:${c}">[${n}] ${t} ${m}</div>`);
  $log.scrollTop = $log.scrollHeight;
};

let s = null;

const init = (url) => {
  if (!url) return l('URL ERR', 'Empty URL', '#f00');
  if (s && (s.readyState === 0 || s.readyState === 1)) {
    return l('CONNECT ERR', 'Already connecting/connected', '#f80');
  }
  if (s) s.close();
  try {
    s = new Socket(url, l);
    s.on(onMsg);
    $connect.textContent = 'Connecting...';
    $connect.disabled = true;
    l('[INIT]', url, '#0f0');
  } catch (e) {
    l('FATAL', e.message, '#f00');
    $connect.textContent = 'Connect';
    $connect.disabled = false;
  }
};

$connect.onclick = () => init($url.value.trim() || 'wss://echo.websocket.org');

// Reset button khi disconnect
const resetBtn = () => {
  $connect.textContent = 'Connect';
  $connect.disabled = false;
};

// Gọi khi có sự kiện onclose hoặc onerror
Socket.prototype._resetUI = resetBtn;

// Gọi init mặc định
init($url.value);

// === SEND FUNCTIONS (sửa lỗi: dùng s thay vì Socket) ===
const send = (t, d) => {
  if (!s || s.readyState !== 1) return l('SEND DROP', 'Not connected', '#f80');
  try {
    s.send(d);
    l(`→ ${t}`, typeof d === 'object' ? JSON.stringify(d) : d, '#ff0');
  } catch (e) {
    l('SEND ERR', e.message, '#f00');
  }
};

const sendStr = () => send('Str', 'Hello Mobile!');
const sendNum = () => send('Num', 3.14);
const sendObj = () => send('Obj', {x:1,y:2});
const sendArr = () => send('Arr', [1,'a',true]);

const sendBin = () => {
  const b = new ArrayBuffer(30), v = new DataView(b); let o = 0;
  v.setUint8(o++,255); v.setInt8(o++,-128);
  v.setUint16(o,65535,true); o+=2; v.setInt16(o,-32768,true); o+=2;
  v.setUint32(o,4294967295,true); o+=4; v.setInt32(o,-2147483648,true); o+=4;
  v.setFloat32(o,3.14159,true); o+=4; v.setFloat64(o,-2.71828,true); o+=8;
  send('Bin', b);
};

const sendU8 = () => send('U8', new Uint8Array([42]));
const sendI8 = () => send('I8', new Int8Array([-99]));
const sendU16 = () => send('U16', new Uint16Array([60000]));
const sendI16 = () => send('I16', new Int16Array([-30000]));
const sendU32 = () => send('U32', new Uint32Array([4000000000]));
const sendI32 = () => send('I32', new Int32Array([-2000000000]));
const sendF32 = () => send('F32', new Float32Array([1.234567]));
const sendF64 = () => send('F64', new Float64Array([Math.E]));

function onMsg(d) {
  if (typeof d === 'string') return l('← Str', d, '#0ff');
  if (d instanceof ArrayBuffer) {
    const v = new DataView(d), len = d.byteLength;
    let str = `← Bin (${len}B): `;
    if (len === 1) str += `U8=${new Uint8Array(d)[0]} I8=${new Int8Array(d)[0]}`;
    else if (len === 2) {
      const u = v.getUint16(0,true), i = v.getInt16(0,true);
      str += `U16=${u} I16=${i}`;
    } else if (len === 4) {
      const u = v.getUint32(0,true), i = v.getInt32(0,true), f = v.getFloat32(0,true);
      str += (u>>>0 === u ? `U32=${u} I32=${i}` : `F32=${f.toFixed(6)}`);
    } else if (len === 8) {
      str += `F64=${v.getFloat64(0,true).toFixed(6)}`;
    } else {
      let p = 0, a = [];
      a.push(`U8=${v.getUint8(p++)}`); a.push(`I8=${v.getInt8(p++)}`);
      a.push(`U16=${v.getUint16(p,true)}`); p+=2; a.push(`I16=${v.getInt16(p,true)}`); p+=2;
      a.push(`U32=${v.getUint32(p,true)}`); p+=4; a.push(`I32=${v.getInt32(p,true)}`); p+=4;
      a.push(`F32=${v.getFloat32(p,true).toFixed(5)}`); p+=4;
      a.push(`F64=${v.getFloat64(p,true).toFixed(5)}`);
      str += a.join(' | ');
    }
    l(str, '', '#0ff'); return;
  }
  try { l('← JSON', JSON.stringify(d), '#0ff'); }
  catch { l('← ???', d, '#f00'); }
}
</script>
</body></html>
